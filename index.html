<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Auto HTML â†’ PDF</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        iframe {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 900px;
            height: 1200px;
            border: none;
        }
    </style>
</head>
<body>

<iframe id="htmlFrame"></iframe>

<script>
function getHTMLFromQuery() {
    const params = new URLSearchParams(window.location.search);
    return params.get("html");
}

async function convertAndDownload() {
    let raw = getHTMLFromQuery();

    if (!raw) {
        document.body.innerHTML = "<h2>No HTML received.</h2>";
        return;
    }

    let decodedHTML = decodeURIComponent(raw);

    // Write the HTML into an isolated iframe (WORKS reliably)
    let frame = document.getElementById("htmlFrame");
    let doc = frame.contentWindow.document;
    doc.open();
    doc.write(decodedHTML);
    doc.close();

    // Wait for the iframe to fully render
    setTimeout(() => {
        html2pdf()
            .from(frame.contentWindow.document.body)
            .set({
                margin: 0.5,
                filename: "document.pdf",
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: "in", format: "letter" }
            })
            .save();
    }, 800); // Give time for images/CSS to render
}

window.onload = () => {
    setTimeout(convertAndDownload, 600);
};
</script>

</body>
</html>
